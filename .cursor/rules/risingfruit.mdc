---
description: Rising Fruit PWA - Mobile-first client for Falling Fruit foraging map
globs: **/*.{ts,tsx,js,jsx,css,html,json,sh,yml,yaml}
---

# Rising Fruit PWA

A Progressive Web App providing a mobile-first interface for the Falling Fruit urban foraging map. This project includes a self-hosted backend that syncs data from Falling Fruit's CSV exports, providing full control over data modeling and query performance.

## Project Identity

- **Name**: Rising Fruit
- **Type**: PWA (Progressive Web App) + Backend Service
- **Target**: Mobile-first, responsive to desktop
- **Purpose**: Client interface for Falling Fruit open-source foraging database

## Architecture Overview

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        Rising Fruit PWA                          ‚îÇ
‚îÇ  (React + Vite + Mantine + Mapbox GL)                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Rising Fruit Backend (EC2)                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ Data Sync   ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  CSV Data    ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  API Server     ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ Script      ‚îÇ    ‚îÇ  (locations, ‚îÇ    ‚îÇ  (future)       ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ   types)     ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚ñ≤
                              ‚îÇ Downloads
                              ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Falling Fruit Exports                         ‚îÇ
‚îÇ  - https://fallingfruit.org/locations.csv.bz2                   ‚îÇ
‚îÇ  - https://fallingfruit.org/types.csv.bz2                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Tech Stack

### Frontend

| Layer | Technology | Version |
|-------|------------|---------|
| Framework | React | 18+ |
| Build Tool | Vite | 5+ |
| Language | TypeScript | 5+ (strict mode) |
| UI Library | Mantine | 7+ |
| Maps | Mapbox GL JS | 3+ |
| PWA | vite-plugin-pwa | latest |
| State/Cache | TanStack Query | 5+ |
| Icons | Lucide React | latest |

### Backend

| Layer | Technology | Purpose |
|-------|------------|---------|
| Runtime | Docker | Container orchestration |
| Host | AWS EC2 | Production server |
| API Framework | FastAPI | REST API server |
| Database | SQLite + R-tree | Spatial queries with R-tree index |
| Data Sync | Bash + curl + bzip2 | Download Falling Fruit exports |
| CI/CD | GitHub Actions | Automated deployment |

## Project Structure

```
risingfruit/
‚îú‚îÄ‚îÄ .cursor/
‚îÇ   ‚îî‚îÄ‚îÄ rules/
‚îÇ       ‚îî‚îÄ‚îÄ risingfruit.mdc     # This file
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îî‚îÄ‚îÄ deploy.yml          # EC2 deployment workflow
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schema.sql          # SQLite schema with R-tree
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ import.py           # CSV to SQLite import script
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.py             # FastAPI application
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ database.py         # Database utilities
‚îÇ   ‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sync-data.sh        # Download Falling Fruit CSVs
‚îÇ   ‚îú‚îÄ‚îÄ data/                   # CSVs and SQLite DB (gitignored)
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt        # Python dependencies
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îî‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ api-reference.md        # Falling Fruit API Blueprint
‚îÇ   ‚îî‚îÄ‚îÄ architecture.md         # System architecture
‚îú‚îÄ‚îÄ frontend/                   # Frontend source
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Map.tsx         # Main map component with Mapbox GL
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LocationSheet.tsx # Bottom sheet for location details
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SearchBar.tsx   # Plant type search
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FilterPanel.tsx # Season filter UI
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FruitIcons.ts   # Emoji/SVG marker icons
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MarkerIcons.ts  # Base marker SVGs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api.ts          # Backend API client
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ colors.ts       # Color constants
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ typeIdMappings.ts # Type ID to icon mapping
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ fruitSeasons.ts # Season logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ location.ts     # TypeScript interfaces
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ theme.ts            # Mantine theme configuration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ App.tsx             # Root component with providers
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.tsx            # Entry point
‚îÇ   ‚îú‚îÄ‚îÄ e2e/                    # Playwright E2E tests
‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ .env.local                  # Local secrets (gitignored)
‚îî‚îÄ‚îÄ .gitignore
```

## Data Sources

The backend syncs data from Falling Fruit's public CSV exports:

| File | URL | Description |
|------|-----|-------------|
| Locations | https://fallingfruit.org/locations.csv.bz2 | All foraging locations worldwide |
| Types | https://fallingfruit.org/types.csv.bz2 | Plant/food type definitions |

### Data Sync

Run the sync script manually or via Docker:

```bash
# Local execution
cd backend
./scripts/sync-data.sh

# Force re-download
./scripts/sync-data.sh --force

# Via Docker
docker-compose up backend
```

## Backend Development

### Docker Commands

```bash
cd backend

# Build image
docker-compose build

# Start services
docker-compose up -d

# View logs
docker-compose logs -f

# Stop services
docker-compose down

# Rebuild and restart
docker-compose up -d --build
```

### Local Testing (without Docker)

```bash
cd backend

# Ensure bzip2 is installed
brew install bzip2  # macOS
apt-get install bzip2  # Ubuntu

# Run sync script
DATA_DIR=./data ./scripts/sync-data.sh
```

## Deployment

### GitHub Actions Workflow

Deployment is automated via `.github/workflows/deploy.yml`:

1. Triggered on push to `main` branch
2. Copies backend files to EC2 via rsync
3. Builds Docker image on EC2
4. Starts container with docker-compose

### Required GitHub Secrets

Configure these in your repository settings:

| Secret | Description |
|--------|-------------|
| `EC2_HOST` | EC2 hostname (e.g., `ec2-xx-xx-xx-xx.region.compute.amazonaws.com`) |
| `EC2_USER` | SSH username (typically `ec2-user` or `ubuntu`) |
| `EC2_SSH_KEY` | Private key contents for SSH access |

### Manual Deployment

```bash
# SSH into EC2
ssh -i your-key.pem ec2-user@your-ec2-host

# Navigate to app directory
cd ~/risingfruit/backend

# Pull latest and restart
docker-compose pull
docker-compose up -d --build
```

## Frontend

### Coding Conventions

#### TypeScript

- Use strict mode (`"strict": true` in tsconfig)
- Prefer `interface` for object shapes, `type` for unions/intersections
- Export types alongside their implementations
- Use explicit return types for public functions

```typescript
interface Location {
  id: number;
  lat: number;
  lng: number;
  typeIds: number[];
}

export function formatLocation(location: Location): string {
  return `${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}`;
}
```

#### React Components

- Use functional components with hooks exclusively
- Prefer named exports for components
- Colocate component styles, tests, and types
- Use descriptive, PascalCase names

```typescript
interface LocationCardProps {
  location: Location;
  onSelect?: (id: number) => void;
}

export function LocationCard({ location, onSelect }: LocationCardProps) {
  // Implementation
}
```

#### File Naming

- Components: `PascalCase.tsx`
- Hooks: `useCamelCase.ts`
- Utilities: `camelCase.ts`
- Types: `camelCase.types.ts` or inline
- Constants: `SCREAMING_SNAKE_CASE`
- Shell scripts: `kebab-case.sh`

### Mobile-First Design Principles

- Minimum touch target: 44x44px (Apple HIG)
- Adequate spacing between interactive elements
- Thumb-friendly bottom sheet for location details
- Glass-morphism UI (semi-transparent backgrounds with blur)
- Responsive breakpoints using Mantine's responsive props

### Performance Budget

- First Contentful Paint: < 1.5s
- Time to Interactive: < 3s
- Largest Contentful Paint: < 2.5s
- Bundle size (gzipped): < 200KB initial

### Testing

E2E tests use Playwright with custom fixtures:

```bash
cd frontend

# Run all tests
npx playwright test

# Run specific test file
npx playwright test markers.spec.ts

# Run with UI mode
npx playwright test --ui
```

Key test selectors:
- `data-testid="filter-panel"` - Filter panel container
- `data-testid="location-sheet"` - Location detail sheet
- `data-testid="season-filter"` - Season toggle button
- `placeholder="Search plants..."` - Search input

## Environment Variables

```bash
# .env.local (do not commit)

# EC2 Deployment
VITE_EC2_HOST=ec2-xx-xx-xx-xx.region.compute.amazonaws.com
VITE_EC2_KEY=/path/to/keypair.pem

# Frontend (future)
VITE_API_BASE_URL=https://your-ec2-host/api
VITE_MAPBOX_TOKEN=pk.your_mapbox_token_here
```

## Design System

### Colors (Mantine Theme)

The app uses a custom Mantine theme defined in `frontend/src/theme.ts`:

```typescript
// Theme colors - 10 shades each (0-9)
const colors = {
  // Surface - Dark theme backgrounds (0 = lightest, 9 = darkest)
  surface: ['#fafafa', ..., '#171717'],
  
  // Primary - Nature green (brand color, in-season indicators)
  primary: ['#f0fdf4', ..., '#22c55e', ..., '#14532d'],
  
  // Accent - Fruit orange (highlights, unverified markers)
  accent: ['#fff7ed', ..., '#f97316', ..., '#7c2d12'],
};
```

### Component Usage

Use Mantine components with theme-aware styling:

```typescript
import { Box, Paper, Text, Button, Group, Stack } from '@mantine/core';

<Paper bg="surface.9" p="md" radius="lg">
  <Text c="primary.4" fw={600}>In Season</Text>
</Paper>
```

### Icons

Use Lucide React for consistent iconography:

```typescript
import { MapPin, Leaf, Search, Calendar, X } from 'lucide-react';
```

### Fruit/Emoji Icons

Custom marker icons are defined in `frontend/src/components/FruitIcons.ts`:
- Emoji-based icons for common fruits (apple üçé, lemon üçã, grape üçá, etc.)
- Custom SVG icons for exotic fruits without emoji equivalents
- Season-aware borders (green = in season, gray = out of season)
- Type ID mappings in `frontend/src/lib/typeIdMappings.ts`

## Git Conventions

### Branch Naming

- `feature/description` - New features
- `fix/description` - Bug fixes
- `chore/description` - Maintenance tasks

### Commit Messages

Follow Conventional Commits:

```
feat: add location clustering on map
fix: resolve offline sync issue
chore: update dependencies
```

## External Resources

- Falling Fruit Website: https://fallingfruit.org/
- Falling Fruit GitHub: https://github.com/falling-fruit/falling-fruit
- Mapbox GL JS Docs: https://docs.mapbox.com/mapbox-gl-js/
- TanStack Query Docs: https://tanstack.com/query/latest
- Vite PWA Plugin: https://vite-pwa-org.netlify.app/
- Docker Docs: https://docs.docker.com/
