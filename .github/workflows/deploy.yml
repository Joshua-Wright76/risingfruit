name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  DOCKER_IMAGE: risingfruit-backend
  DEPLOY_PATH: /home/${{ secrets.EC2_USER }}/risingfruit

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          # Set production API URL (same server, port 8000)
          echo "VITE_API_BASE_URL=" > .env.production
          echo "VITE_MAPBOX_TOKEN=${{ secrets.MAPBOX_TOKEN }}" >> .env.production
          npm run build
        env:
          VITE_MAPBOX_TOKEN: ${{ secrets.MAPBOX_TOKEN }}

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          # Retry ssh-keyscan a few times in case of transient network issues
          for i in 1 2 3; do
            if ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>&1; then
              echo "ssh-keyscan succeeded"
              break
            fi
            echo "ssh-keyscan attempt $i failed, retrying..."
            sleep 5
          done

      - name: Test SSH connection
        run: |
          ssh -i ~/.ssh/ec2_key -o BatchMode=yes -o ConnectTimeout=10 \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "echo 'SSH connection successful'"

      - name: Install Docker on EC2 (if needed)
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            # Check if Docker is installed
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              sudo yum update -y
              sudo yum install -y docker
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -aG docker $USER
              echo "Docker installed successfully"
            else
              echo "Docker already installed"
            fi
            
            # Ensure Docker is running
            sudo systemctl start docker
            
            # Install/update Docker Compose plugin and buildx
            echo "Installing/updating Docker Compose and buildx..."
            sudo mkdir -p /usr/local/lib/docker/cli-plugins
            
            # Install latest docker-compose
            sudo curl -SL "https://github.com/docker/compose/releases/download/v2.32.4/docker-compose-linux-x86_64" \
              -o /usr/local/lib/docker/cli-plugins/docker-compose
            sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
            
            # Install latest buildx
            sudo curl -SL "https://github.com/docker/buildx/releases/download/v0.19.3/buildx-v0.19.3.linux-amd64" \
              -o /usr/local/lib/docker/cli-plugins/docker-buildx
            sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-buildx
            
            echo "Docker Compose and buildx installed"
            docker --version
            docker compose version
            docker buildx version
          EOF

      - name: Create deployment directory on EC2
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "mkdir -p ~/risingfruit/backend/frontend/dist"

      - name: Copy backend files to EC2
        run: |
          rsync -avz --delete --exclude='data/' --exclude='frontend/' --exclude='certbot/' \
            -e "ssh -i ~/.ssh/ec2_key" \
            ./backend/ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/risingfruit/backend/

      - name: Copy frontend build to EC2
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/ec2_key" \
            ./frontend/dist/ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/risingfruit/backend/frontend/dist/

      - name: Clean up Docker resources on EC2
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            echo "=== Disk space before cleanup ==="
            df -h /
            
            # Clean up unused Docker resources to free disk space
            echo "Cleaning up Docker resources..."
            sudo docker system prune -af --volumes 2>/dev/null || true
            sudo docker builder prune -af 2>/dev/null || true
            
            echo "=== Disk space after cleanup ==="
            df -h /
          EOF

      - name: Build and deploy Docker container
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd ~/risingfruit/backend
            
            # Stop and remove existing containers
            sudo docker compose down --remove-orphans || true
            
            # Check if SSL certificates exist for risingfruit.com
            if [ ! -f ~/risingfruit/backend/certbot/conf/live/risingfruit.com/fullchain.pem ]; then
              echo "SSL certificates for risingfruit.com not found, obtaining initial certificates..."
              mkdir -p ~/risingfruit/backend/certbot/conf ~/risingfruit/backend/certbot/www
              
              # Run temporary nginx to handle acme challenge
              sudo docker run -d --name temp-nginx -p 80:80 \
                -v ~/risingfruit/backend/certbot/www:/usr/share/nginx/html:ro nginx:alpine
              
              sleep 5
              
              # Request certificate for risingfruit.com
              sudo docker run --rm --name certbot \
                -v ~/risingfruit/backend/certbot/conf:/etc/letsencrypt \
                -v ~/risingfruit/backend/certbot/www:/var/www/certbot \
                certbot/certbot certonly --webroot -w /var/www/certbot \
                -d risingfruit.com -d www.risingfruit.com \
                --email joshua@risingfruit.com --agree-tos --no-eff-email \
                --non-interactive
              
              sudo docker stop temp-nginx || true
              sudo docker rm temp-nginx || true
            fi
            
            # Build new image (no cache)
            sudo docker compose build --no-cache
            
            # Start container
            sudo docker compose up -d
            
            # Wait for container to start
            sleep 10
            
            # Show status
            sudo docker compose ps
            
            # Show logs
            sudo docker compose logs --tail=100
          EOF

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd ~/risingfruit/backend
            
            # Show container status
            echo "=== Container Status ==="
            sudo docker compose ps -a
            
            # Show recent logs
            echo "=== Recent Logs ==="
            sudo docker compose logs --tail=50
            
            # Check if container is running
            if sudo docker compose ps | grep -q "Up\|running"; then
              echo "✅ Container is running"
            else
              echo "❌ Container is not in running state"
              # Don't fail - import may still be in progress
            fi
            
            # Test frontend is being served over HTTPS
            echo "=== Testing Frontend (HTTPS) ==="
            curl -s -k -o /dev/null -w "%{http_code}" https://localhost/ || echo "Frontend HTTPS test failed"
            
            # Test API is reachable
            echo "=== Testing API (HTTPS) ==="
            curl -s -k -o /dev/null -w "%{http_code}" https://localhost/api/health || echo "API HTTPS test failed"
          EOF

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/ec2_key
